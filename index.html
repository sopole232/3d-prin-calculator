<!DOCTYPE html> 
<html lang="es"> 
    <head> 
        <meta charset="UTF-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <title>Panel Impresi√≥n 3D</title>         
        <link rel="stylesheet" href="styles.css"> 
    </head>     
    <body> 
        <div class="container">            <div class="header"> 
                <h1>üñ®Ô∏è Panel de Impresi√≥n 3D</h1> 
                <p>Gesti√≥n completa de costos y filamentos ‚Ä¢ Guardado autom√°tico activo</p>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('filamentos')">üì¶ Filamentos</button>                 
                <button class="tab" onclick="showTab('calculator')">üßÆ Calculadora</button>                 
                <button class="tab" onclick="showTab('perfiles-costos')">üñ®Ô∏è Impresoras</button>                 
                <button class="tab" onclick="showTab('historico')">üìä Hist√≥rico</button>                 
                <button class="tab" onclick="showTab('configuracion')">‚öôÔ∏è Configuraci√≥n</button>                 
            </div>             
            <!-- Contenido de las pesta√±as -->             
            <div id="filamentos" class="tab-content active"> 
                <h2>Gesti√≥n de Filamentos</h2> 
                <div class="card"> 
                    <h3>Agregar Nuevo Filamento</h3> 
                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>Nombre/Marca:</label>                             
                            <input type="text" id="nombreFilamento" placeholder="Ej: Prusament PLA"> 
                        </div>                         
                        <div class="form-group"> 
                            <label>Tipo de Material:</label>                             
                            <select id="tipoMaterial" class="galaxy-select"> 
                                <option value="">üîÑ Cargando materiales...</option>                                 
                            </select>                             
                        </div>                         
                    </div>                     
                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>Color (opcional):</label>                             
                            <input type="text" id="colorFilamento" placeholder="Ej: Azul, Rojo, Natural"> 
                        </div>                         
                        <div class="form-group"> 
                            <label>Peso del rollo (kg):</label>                             
                            <input type="number" id="pesoRollo" value="1" step="0.1" min="0.1"> 
                        </div>                         
                    </div>                     
                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>Precio total pagado (‚Ç¨):</label>                             
                            <input type="number" id="precioTotal" step="0.01" min="0" placeholder="25.99"> 
                        </div>                         
                        <div class="form-group"> 
                            <label>Precio por kg (‚Ç¨/kg) - Calculado autom√°ticamente:</label>                             
                            <input type="number" id="precioPorKg" readonly> 
                        </div>                         
                    </div>                     
                    <div class="form-group"> 
                        <label>URL de compra (opcional):</label>                         
                        <input type="url" id="urlFilamento" placeholder="https://tienda.com/producto-filamento"> <small>Enlace donde compraste o donde se puede comprar este filamento</small> 
                    </div>                     
                    <div class="form-row-vertical"> 
                        <div class="form-group"> 
                            <label>Dificultad de impresi√≥n (1-10):</label>                             
                            <div class="scale-input"> 
                                <input type="range" id="dificultadImpresion" min="1" max="10" value="3" oninput="UI.updateScale('dificultad', this.value)"> <span class="scale-value" id="dificultadValue">3</span> 
                            </div>                             <small>1=Muy f√°cil, 10=Muy dif√≠cil</small> 
                        </div>                         
                        <div class="form-group"> 
                            <label>Desgaste de impresora (1-10):</label>                             
                            <div class="scale-input"> 
                                <input type="range" id="desgasteImpresora" min="1" max="10" value="3" oninput="UI.updateScale('desgaste', this.value)"> <span class="scale-value" id="desgasteValue">3</span> 
                            </div>                             <small>1=M√≠nimo desgaste, 10=Alto desgaste</small> 
                        </div>                         
                    </div>                     
                    <div class="form-group-single"> 
                        <label>¬øRequiere secado?</label>                         
                        <select id="requiereSecado" class="galaxy-select"> 
                            <option value="no">No</option>                             
                            <option value="si">S√≠</option>                             
                        </select>                         
                    </div>                     
                    <div class="form-actions"> 
                        <button class="btn btn-success" onclick="agregarFilamento()">‚ûï Agregar Filamento</button>                         
                    </div>                     
                </div>                 
                <div class="card"> 
                    <div class="section-header"> 
                        <h3>Filamentos Registrados</h3> 
                        <button class="btn" onclick="app.managers.filament.exportarFilamentos()" title="Exportar filamentos a CSV"> 
                            üìä Exportar CSV
</button>                         
                    </div>                     
                    <div id="listaFilamentos"></div>                     
                </div>                 
            </div>             
            <div id="calculator" class="tab-content"> 
                <h2>Calculadora de Costos</h2> 
                <div class="active-profile-display" id="perfilActivo"> 
                    <h3>üìã Perfil Activo: <span id="nombrePerfilActivo">Ninguno seleccionado</span></h3> 
                    <div id="resumenPerfilActivo"></div>                     
                </div>                 
                <div class="card"> 
                    <h3>Configuraci√≥n de Impresi√≥n</h3> 
                    
                    <!-- Selecci√≥n principal: Tipo de impresi√≥n -->
                    <div class="form-group-primary">
                        <label class="form-label-primary">üéØ Tipo de impresi√≥n:</label>
                        <select id="tipoImpresion" class="galaxy-select" onchange="cambiarTipoImpresion()">
                            <option value="individual">üî∑ Individual - Una sola pieza</option>
                            <option value="multiple">üî∂ M√∫ltiple - Varias piezas diferentes</option>
                        </select>
                        <small class="form-help">Selecciona si vas a imprimir una pieza o m√∫ltiples piezas con diferentes materiales</small>
                    </div>

                    <!-- Configuraci√≥n b√°sica -->
                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>Perfil de impresora:</label>                             
                            <select id="perfilSeleccionado" class="galaxy-select" onchange="cambiarPerfilActivo()"> 
                                <option value="">Selecciona un perfil</option>                                 
                            </select>                             
                        </div>                         
                        <div class="form-group"> 
                            <label>Tiempo de impresi√≥n:</label>
                            <div class="time-input-group">
                                <input type="number" id="tiempoHoras" min="0" max="999" placeholder="Horas" style="width: 120px;">
                                <span>h</span>
                                <input type="number" id="tiempoMinutos" min="0" max="59" placeholder="Min" style="width: 100px;">
                                <span>m</span>
                            </div>
                        </div>                         
                    </div>

                    <!-- Secci√≥n de Impresi√≥n Individual -->
                    <div id="seccionIndividual" class="printing-mode-section">
                        <h4>üî∑ Configuraci√≥n de Pieza Individual</h4>
                        
                        <!-- Opci√≥n multicolor para individual -->
                        <div class="form-group"> 
                            <label>üé® Tipo de material:</label>                         
                            <select id="esMultiMaterialIndividual" class="galaxy-select" onchange="toggleMultiMaterialIndividual()"> 
                                <option value="no">üî∏ Un solo color</option>                             
                                <option value="si">üåà M√∫ltiples colores</option>                             
                            </select>
                            <small>Selecciona si la pieza usa un solo filamento o m√∫ltiples filamentos</small>                         
                        </div>

                        <!-- Secci√≥n para UN SOLO COLOR -->
                        <div id="singleColorIndividualSection" class="single-color-section">
                            <div class="form-row">
                                <div class="form-group"> 
                                    <label>Filamento:</label>                             
                                    <select id="filamentoSeleccionado" class="galaxy-select" onchange="mostrarInfoFilamento()"></select>
                                    <!-- Indicador de color del filamento -->
                                    <div id="filamentoColorIndicator" class="filamento-color-indicator" style="display: none;">
                                        <span class="color-muestra" id="filamentoColorMuestra"></span>
                                        <span class="color-texto" id="filamentoColorTexto"></span>
                                    </div>                             
                                </div>
                                <div class="form-group"> 
                                    <label>Cantidad usada (gramos):</label>                             
                                    <input type="number" id="cantidadFilamento" min="0" step="0.1" placeholder="Ej: 50"> 
                                </div>
                            </div>
                        </div>

                        <!-- Secci√≥n para M√öLTIPLES COLORES -->
                        <div id="multiMaterialIndividualSection" class="multi-filament hidden"> 
                            <h5>üåà Configuraci√≥n de filamentos para pieza multicolor</h5> 
                            <p class="section-description">Agrega cada filamento que usa esta pieza y su cantidad espec√≠fica</p>
                            
                            <!-- Total de gramos para esta pieza -->
                            <div class="total-gramos-individual">
                                <strong>Total de material: <span id="totalGramosIndividual">0g</span></strong>
                            </div>
                            
                            <div id="filamentosAdicionalesIndividual" class="filamentos-multicolor-list">
                                <!-- Primer filamento (principal) -->
                                <div class="filamento-multicolor-item">
                                    <h6>üé® Filamento 1</h6>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Filamento:</label>
                                            <select class="filamento-multicolor-individual galaxy-select" onchange="actualizarTotalIndividual()">
                                                <option value="">Selecciona filamento</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Cantidad (gramos):</label>
                                            <input type="number" class="cantidad-multicolor-individual" min="0" step="0.1" placeholder="Ej: 30" onchange="actualizarTotalIndividual()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn galaxy-btn" onclick="agregarFilamentoAdicionalIndividual()">+ Agregar filamento</button>                         
                        </div>

                        <!-- Configuraci√≥n de piezas externas -->
                        <div class="form-group">
                            <label>üîß ¬øIncluye piezas externas?</label>
                            <select id="tienePiezasExternas" class="galaxy-select" onchange="togglePiezasExternas()">
                                <option value="no">No - Solo impresi√≥n</option>
                                <option value="si">S√≠ - Incluye tornillos, imanes, etc.</option>
                            </select>
                            <small>Selecciona si el proyecto requiere piezas adicionales no impresas</small>
                        </div>

                        <!-- Piezas externas para ensamblaje (solo si se selecciona) -->
                        <div id="piezasExternasSection" class="external-parts-section hidden">
                            <h5>üîß Piezas externas (no impresas)</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>N√∫mero de piezas externas:</label>
                                    <input type="number" id="numPiezasExternas" min="0" max="50" value="0" onchange="calcularCostoEnsamblaje()">
                                    <small>Tornillos, tuercas, imanes, etc. (‚Ç¨1 de ensamblaje por pieza extra)</small>
                                </div>
                                <div class="form-group">
                                    <label>Costo total piezas externas (‚Ç¨):</label>
                                    <input type="number" id="costoPiezasExternas" min="0" step="0.01" placeholder="Ej: 5.50" value="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Costo de ensamblaje (‚Ç¨):</label>
                                <input type="number" id="costoEnsamblaje" min="0" step="0.01" value="0" readonly class="input-readonly">
                                <small>Calculado autom√°ticamente: ‚Ç¨1 √ó n√∫mero de piezas externas</small>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n de Impresi√≥n M√∫ltiple -->
                    <div id="seccionMultiple" class="printing-mode-section hidden">
                        <h4>üî∂ Configuraci√≥n de M√∫ltiples Piezas</h4>
                        <p class="section-description">Configura cada pieza con su filamento espec√≠fico y cantidad de material</p>

                        <!-- Estad√≠sticas de material total -->
                        <div id="estadisticasMaterial" class="material-stats-panel">
                            <h5>üìä Estad√≠sticas de Material</h5>
                            <div id="resumenMateriales" class="material-summary"></div>
                        </div>

                        <!-- Lista de piezas m√∫ltiples -->
                        <div id="listaPiezasMultiples" class="pieces-list">
                            <!-- Primera pieza (principal) -->
                            <div class="piece-item piece-principal" data-piece-id="principal">
                                <h6>üî∏ Pieza Principal</h6>
                                
                                <!-- Selector tipo de material para esta pieza -->
                                <div class="form-group">
                                    <label>üé® Tipo de material:</label>
                                    <select class="tipo-material-pieza galaxy-select" onchange="toggleMultiMaterialPieza('principal')">
                                        <option value="single">üî∏ Un solo color</option>
                                        <option value="multi">üåà M√∫ltiples colores</option>
                                    </select>
                                </div>

                                <!-- Secci√≥n un solo color -->
                                <div class="single-color-pieza-section">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Filamento:</label>
                                            <select class="filamento-pieza-single galaxy-select" onchange="actualizarEstadisticasMaterial()">
                                                <option value="">Selecciona filamento</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Cantidad (gramos):</label>
                                            <input type="number" class="cantidad-pieza-single" min="0" step="0.1" placeholder="Ej: 50" onchange="actualizarEstadisticasMaterial()">
                                        </div>
                                    </div>
                                </div>

                                <!-- Secci√≥n m√∫ltiples colores -->
                                <div class="multi-color-pieza-section hidden">
                                    <h6>üåà Filamentos para esta pieza</h6>
                                    <div class="total-gramos-pieza">
                                        <strong>Total pieza: <span class="total-gramos-value">0g</span></strong>
                                    </div>
                                    <div class="filamentos-pieza-list">
                                        <!-- Primer filamento -->
                                        <div class="filamento-multicolor-pieza-item">
                                            <h6>üé® Filamento 1</h6>
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label>Filamento:</label>
                                                    <select class="filamento-multicolor-pieza galaxy-select" onchange="actualizarTotalPieza('principal')">
                                                        <option value="">Selecciona filamento</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label>Cantidad (gramos):</label>
                                                    <input type="number" class="cantidad-multicolor-pieza" min="0" step="0.1" placeholder="Ej: 30" onchange="actualizarTotalPieza('principal')">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn galaxy-btn btn-sm" onclick="agregarFilamentoPieza('principal')">+ Agregar filamento</button>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn galaxy-btn" onclick="agregarPiezaMultiple()">+ Agregar pieza adicional</button>
                    </div>

                    <!-- Configuraci√≥n com√∫n -->
                    <div class="cost-config-section"> 
                        <h4>üë®‚Äçüíº Mano de Obra</h4> 
                        <div class="form-row"> 
                            <div class="form-group"> 
                                <label>Tiempo de mano de obra:</label>
                                <div class="time-input-group">
                                    <input type="number" id="tiempoManoObraHoras" min="0" max="999" placeholder="Horas" style="width: 120px;">
                                    <span>h</span>
                                    <input type="number" id="tiempoManoObraMinutos" min="0" max="59" placeholder="Min" style="width: 100px;">
                                    <span>m</span>
                                </div>
                            </div>                             
                            <div class="form-group"> 
                                <label>Tarifa por hora del operador (‚Ç¨/h):</label>                                 
                                <input type="number" id="tarifaOperador" min="0" step="0.01" readonly class="input-readonly"> <small>üìù Configurado en Ajustes ‚Üí Configuraci√≥n</small> 
                            </div>                             
                        </div>                         
                    </div>                     

                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>Tipo de boquilla:</label>                             
                            <select id="tipoBoquilla" class="galaxy-select"> 
                                <option value="estandar">Est√°ndar (‚Ç¨0)</option>                                 
                                <option value="hardened">Hardened Steel (+‚Ç¨2)</option>                                 
                                <option value="ruby">Ruby (+‚Ç¨5)</option>                                 
                            </select>                             
                        </div>                         
                    </div>                     
                    <div class="form-actions"> 
                        <button class="btn btn-success" onclick="calcularCosto()">üßÆ Calcular Costo</button>                         
                    </div>                     
                </div>                 
                <div id="resultadoCalculo"></div>                 
            </div>             
            <div id="perfiles-costos" class="tab-content"> 
                <h2>Gesti√≥n de Impresoras y Perfiles de Costos</h2> 
                <div class="card"> 
                    <h3>Agregar Nueva Impresora</h3> 
                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>Nombre de la Impresora:</label>                             
                            <input type="text" id="nombrePerfil" placeholder="Ej: Prusa i3 MK3S+ - Casa"> 
                        </div>                         
                        <div class="form-group"> 
                            <label>Modelo de Impresora:</label>                             
                            <input type="text" id="modeloPerfil" placeholder="Ej: Prusa i3 MK3S+"> 
                        </div>                         
                    </div>                     
                    <div class="cost-config-section"> 
                        <h4>üí∞ Configuraci√≥n de Amortizaci√≥n de Impresora</h4> 
                        <div class="form-row"> 
                            <div class="form-group"> 
                                <label>Costo total de la impresora (‚Ç¨):</label>                                 
                                <input type="number" id="costoImpresora" min="0" step="0.01" placeholder="Ej: 800" value="800"> <small>Precio pagado por la impresora (incluye accesorios, env√≠o, etc.)</small> 
                            </div>                             
                            <div class="form-group"> 
                                <label>Horas de impresi√≥n para amortizar:</label>                                 
                                <input type="number" id="tiempoAmortizacion" min="1" placeholder="Ej: 1000" value="1000"> <small>En cu√°ntas horas de impresi√≥n quieres recuperar la inversi√≥n</small> 
                            </div>                             
                        </div>                         
                        <div class="form-row"> 
                            <div class="form-group"> 
                                <label>Factor de amortizaci√≥n (‚Ç¨/hora):</label>                                 
                                <input type="number" id="factorAmortizacionPerfil" min="0" step="0.0001" readonly class="input-readonly-secondary"> <small>Se calcula autom√°ticamente: Costo Impresora √∑ Horas de Amortizaci√≥n</small> 
                            </div>                             
                        </div>                         
                        <div id="estadisticasAmortizacion" class="stats-amortization"></div>                         
                    </div>                     
                    <div class="cost-config-section"> 
                        <h4>‚ö° Configuraci√≥n de Electricidad</h4> 
                        <div class="form-row"> 
                            <div class="form-group"> 
                                <label>Potencia de consumo (W):</label>                                 
                                <input type="number" id="potenciaPerfil" min="0" placeholder="Ej: 200" value="200"> 
                            </div>                             
                            <div class="form-group"> 
                                <label>Costo de electricidad (‚Ç¨/kWh):</label>                                 
                                <input type="number" id="costoElectricidadPerfil" min="0" step="0.001" placeholder="Ej: 0.150" value="0.15"> 
                            </div>                             
                        </div>                         
                    </div>                     
                    <div class="cost-config-section"> 
                        <h4>üîß Configuraci√≥n de Mantenimiento</h4> 
                        <div class="form-row"> 
                            <div class="form-group"> 
                                <label>Costo de mantenimiento (‚Ç¨):</label>                                 
                                <input type="number" id="costoMantenimientoPerfil" min="0" step="0.01" placeholder="Ej: 60" value="60"> <small>Costo cada vez que se hace mantenimiento completo</small> 
                            </div>                             
                            <div class="form-group"> 
                                <label>Intervalo de mantenimiento (horas):</label>                                 
                                <input type="number" id="intervaloMantenimientoPerfil" min="1" placeholder="Ej: 250" value="250"> <small>Cada cu√°ntas horas se requiere mantenimiento</small> 
                            </div>                             
                        </div>                         
                    </div>                     
                    <div class="cost-config-section"> 
                        <h4>üì¶ Configuraci√≥n de Material y Errores</h4> 
                        <div class="form-row"> 
                            <div class="form-group"> 
                                <label>Desperdicio de material (%):</label>                                 
                                <input type="number" id="desperdicioMaterialPerfil" min="0" step="0.1" placeholder="Ej: 5" value="5"> <small>Porcentaje de material perdido en soportes, purgas, etc.</small> 
                            </div>                             
                            <div class="form-group"> 
                                <label>Recargo por impresi√≥n multi-material (%):</label>                                 
                                <input type="number" id="recargoMultiMaterialPerfil" min="0" step="0.1" placeholder="Ej: 15" value="15"> <small>Recargo adicional por mayor complejidad y posibles errores en multicolor</small> 
                            </div>
                            <div class="form-group"> 
                                <label>Recargo por impresi√≥n multi-piezas (%):</label>                                 
                                <input type="number" id="recargoMultiPiezasPerfil" min="0" step="0.1" placeholder="Ej: 10" value="10"> <small>Recargo adicional por gesti√≥n de m√∫ltiples piezas con diferentes materiales</small> 
                            </div>                             
                        </div>                         
                        <div class="form-row"> 
                            <div class="form-group"> 
                                <label>üõ°Ô∏è Factor de Seguridad para Errores (multiplicador):</label>                                 
                                <input type="number" id="bufferErroresPerfil" min="1" step="0.1" placeholder="Ej: 2.0" value="2" oninput="mostrarEstadisticasAmortizacion()"> <small><strong>‚ö†Ô∏è IMPORTANTE:</strong> Solo se aplica a costos variables (material, electricidad, mantenimiento)</small> <small>Factor 2.0 = 100% extra, Factor 1.5 = 50% extra, Factor 1.2 = 20% extra</small> 
                            </div>                             
                        </div>                         

                        <div class="bg-info info-section"> <strong>üí° ¬øQu√© es el Factor de Seguridad?</strong>
                            <br> <small class="info-detail"> 
                        ‚Ä¢ Multiplica los costos variables para compensar posibles fallos<br> 
                        ‚Ä¢ Costos que S√ç se multiplican: Material, Electricidad, Mantenimiento<br> 
                        ‚Ä¢ Costos que NO se multiplican: Amortizaci√≥n, Mano de obra, Boquilla, Piezas externas<br> 
                        ‚Ä¢ Ejemplo: Factor 2.0 en impresi√≥n de ‚Ç¨10 ‚Üí ‚Ç¨20 en costos variables + costos fijos normales
 </small> 
                        </div>                         
                    </div>                     
                    <div class="form-actions"> 
                        <button class="btn btn-success" onclick="crearPerfil()">‚ûï Agregar Impresora</button>                         
                    </div>                     
                </div>                 
                <div class="card"> 
                    <h3>Impresoras Registradas</h3> 
                    <div id="listaPerfiles"></div>                     
                </div>                 
            </div>             
            <div id="historico" class="tab-content"> 
                <h2>Hist√≥rico de C√°lculos</h2> 
                <div class="card"> 
                    <button class="btn btn-danger" onclick="HistoryManager.limpiar()">üóëÔ∏è Limpiar Hist√≥rico</button>                     
                </div>                 
                <div id="listaHistorico"></div>                 
            </div>             
            <div id="configuracion" class="tab-content"> 
                <h2>Configuraci√≥n General</h2> 
                <div class="card"> 
                    <h3>Estado del Guardado Autom√°tico</h3> 
                    <div class="bg-success success-section"> 
                        <h4>‚úÖ Guardado Autom√°tico Activo</h4> 
                        <ul class="feature-list"> 
                            <li>Los datos se guardan autom√°ticamente cada 30 segundos</li>                             
                            <li>Se crean backups autom√°ticos cada 5 minutos</li>                             
                            <li>Todo se almacena localmente en tu navegador</li>                             
                            <li>No necesitas hacer nada manual</li>                             
                        </ul>                         
                        <div class="button-section"> 
                            <button class="btn btn-secondary" onclick="DataManager.mostrarInfoBackup()">üì¶ Ver Info de Backups</button>                             
                            <button class="btn btn-secondary" onclick="DataManager.exportarBackupManual()">üíæ Descargar Backup Manual</button>                             
                        </div>                         
                    </div>                     
                </div>                 
                <div class="card"> 
                    <h3>Configuraci√≥n de Precios y Negocio</h3> 
                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>Margen de ganancia por defecto (%):</label>                             
                            <input type="number" id="gananciaPorDefecto" min="0" step="1" placeholder="Ej: 30" value="30"> <small>Margen aplicado cuando no se especifica uno en el perfil de impresora</small> 
                        </div>                         
                        <div class="form-group"> 
                            <label>Redondeo de precios:</label>                             
                            <select id="redondeoPrecios" class="galaxy-select"> 
                                <option value="0.01">Centimos (‚Ç¨0.01)</option>                                 
                                <option value="0.05">5 centimos (‚Ç¨0.05)</option>                                 
                                <option value="0.10">10 centimos (‚Ç¨0.10)</option>                                 
                                <option value="0.50">50 centimos (‚Ç¨0.50)</option>                                 
                                <option value="1.00">Euros (‚Ç¨1.00)</option>                                 
                            </select>                             
                        </div>                         
                    </div>                     
                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>Tarifa por hora del operador (‚Ç¨/h):</label>                             
                            <input type="number" id="tarifaOperadorDefecto" min="0" step="0.01" placeholder="Ej: 15.00" value="15"> <small>Tarifa est√°ndar para mano de obra en c√°lculos</small> 
                        </div>                         
                    </div>                     
                    <div class="form-actions"> 
                        <button class="btn btn-success" onclick="guardarConfiguracionGeneral()">üíæ Guardar Configuraci√≥n (Auto-Guardado)</button>                         
                    </div>                     
                </div>                 
                <div class="card"> 
                    <h3>‚òÅÔ∏è Sincronizaci√≥n en la Nube</h3>
                    <div id="cloudSyncSection"></div>
                </div>
                
                <div class="card"> 
                    <h3>Gesti√≥n de Datos</h3> 
                    <div class="button-group"> 
                        <button class="btn" onclick="exportarDatos()">üì§ Exportar Datos (Descargar)</button>                         
                        <button class="btn" onclick="importarDatos()">üì• Importar Datos (Subir Archivo)</button>                         
                        <button class="btn btn-danger" onclick="limpiarBaseDatos()">üóëÔ∏è Limpiar Todo</button>                         
                    </div>                     <small class="info-note"> 
                    üí° Los datos siempre se guardan autom√°ticamente. La exportaci√≥n es solo para hacer copias de seguridad externas.
 </small> 
                </div>                 
                <div class="card"> 
                    <div id="formulasPersonalizadas"></div>                     
                </div>                 
                <div class="card"> 
                    <div id="materialesPersonalizados"></div>                     
                </div>                 
                <div class="card"> 
                    <h3>Informaci√≥n del Sistema</h3> 
                    <p><strong>Versi√≥n:</strong> 2.0.0 (Guardado Autom√°tico)</p> 
                    <p><strong>√öltima actualizaci√≥n:</strong> <span id="fechaActualizacion"></span></p> 
                    <p><strong>Almacenamiento:</strong> localStorage + IndexedDB (respaldo)</p> 
                    <p><strong>Auto-guardado:</strong> ‚úÖ Activo (cada 30 segundos)</p> 
                    <p><strong>Filamentos registrados:</strong> <span id="contadorFilamentos">0</span></p> 
                    <p><strong>Impresoras registradas:</strong> <span id="contadorImpresoras">0</span></p> 
                    <p><strong>C√°lculos en hist√≥rico:</strong> <span id="contadorCalculos">0</span></p> 
                </div>                 
            </div>             
        </div>         
        <!-- Indicador de estado mejorado -->         
        <div id="dbStatus" class="db-status" style="margin-bottom: 84px;">üîÑ Inicializando auto-guardado...</div>         
        <!-- Scripts modulares - CON FILE STORAGE PRIMERO -->
        <!-- Firebase SDKs -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
        
        <script src="js/file-storage.js"></script>
        <script src="js/firebase-storage.js"></script>
        <script src="js/cloud-sync-manager.js"></script>         
        <script src="formulas/formulas-costos.js"></script>         
        <script src="formulas/formulas-finales.js"></script>         
        <script src="js/storage.js"></script>         
        <script src="js/user-storage.js"></script>         
        <script src="js/firebase-storage.js"></script>         
        <script src="js/cloud-sync-manager.js"></script>         
        <script src="js/auth.js"></script>         
        <script src="js/auth-ui.js"></script>         
        <script src="js/ui.js"></script>         
        <script src="js/config.js"></script>         
        <script src="js/filaments.js"></script>         
        <script src="js/profiles.js"></script>         
        <script src="js/calculator.js"></script>         
        <script src="js/history.js"></script>         
        <script src="js/data.js"></script>         
        <script src="js/backend-editor.js"></script>         
        <script src="js/app.js"></script>         
        <script src="js/database.js"></script>         
        <script src="js/printers.js"></script>         
        <!-- Debugging y compatibilidad - SIMPLIFICADO -->         
        <script>
        // Funci√≥n de debugging b√°sica
        function debugApp() {
            console.log('üîç Estado de la aplicaci√≥n:');
            console.log('App:', window.app);
            console.log('Managers disponibles:', window.app?.managers ? Object.keys(window.app.managers) : 'No disponibles');
            console.log('Datos:', window.app?.data ? Object.keys(window.app.data) : 'No disponibles');
        }

        // Ejecutar debugging despu√©s de 2 segundos
        setTimeout(debugApp, 2000);
        window.debugApp = debugApp;

        // Funciones compatibles con el archivo original
        function agregarFilamento() {
            if (window.app && window.app.managers.filament) {
                window.app.managers.filament.agregar();
            } else {
                console.error('‚ùå FilamentManager no disponible');
            }
        }

        function calcularCosto() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.calcular();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function cambiarTipoImpresion() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.cambiarTipoImpresion();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function toggleMultiMaterialIndividual() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.toggleMultiMaterialIndividual();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function toggleMultiMaterialMultiple() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.toggleMultiMaterialMultiple();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function agregarFilamentoAdicionalIndividual() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.agregarFilamentoAdicionalIndividual();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function agregarPiezaMultiple() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.agregarPiezaMultiple();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function actualizarEstadisticasMaterial() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.actualizarEstadisticasMaterial();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function calcularCostoEnsamblaje() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.calcularCostoEnsamblaje();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function toggleMultiMaterial() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.toggleMultiMaterial();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function agregarFilamentoAdicional() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.agregarFilamentoAdicional();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function toggleMultiPiezas() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.toggleMultiPiezas();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function agregarPiezaAdicional() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.agregarPiezaAdicional();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function crearPerfil() {
            if (window.app && window.app.managers.profile) {
                window.app.managers.profile.crear();
            } else {
                console.error('‚ùå ProfileManager no disponible');
            }
        }

        function seleccionarPerfil(id) {
            if (window.app && window.app.managers.profile) {
                window.app.managers.profile.seleccionar(id);
            } else {
                console.error('‚ùå ProfileManager no disponible');
            }
        }

        function cambiarPerfilActivo() {
            if (window.app && window.app.managers.profile) {
                window.app.managers.profile.cambiarPerfilActivo();
            } else {
                console.error('‚ùå ProfileManager no disponible');
            }
        }

        function calcularFactorAmortizacion() {
            if (window.app && window.app.managers.profile) {
                window.app.managers.profile.calcularFactorAmortizacion();
            } else {
                console.error('‚ùå ProfileManager no disponible');
            }
        }

        function mostrarEstadisticasAmortizacion() {
            if (window.app && window.app.managers.profile) {
                window.app.managers.profile.mostrarEstadisticasAmortizacion();
            } else {
                console.error('‚ùå ProfileManager no disponible');
            }
        }

        function limpiarHistorico() {
            if (window.app && window.app.managers.history) {
                window.app.managers.history.limpiar();
            } else {
                console.error('‚ùå HistoryManager no disponible');
            }
        }

        function guardarConfiguracionGeneral() {
            if (window.app && window.app.managers.config) {
                window.app.managers.config.guardar();
            } else {
                console.error('‚ùå ConfigManager no disponible');
            }
        }

        function exportarDatos() {
            if (window.DataManager) {
                DataManager.exportar();
            } else {
                console.error('‚ùå DataManager no disponible');
            }
        }

        function importarDatos() {
            if (window.DataManager) {
                DataManager.importar();
            } else {
                console.error('‚ùå DataManager no disponible');
            }
        }

        function limpiarBaseDatos() {
            if (window.DataManager) {
                DataManager.limpiarTodo();
            } else {
                console.error('‚ùå DataManager no disponible');
            }
        }

        function updateScale(type, value) {
            UI.updateScale(type, value);
        }

        // === NUEVAS FUNCIONES PARA SISTEMA MULTICOLOR MEJORADO ===
        
        function toggleMultiMaterialPieza(pieceId) {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.toggleMultiMaterialPieza(pieceId);
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function agregarFilamentoPieza(pieceId) {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.agregarFilamentoPieza(pieceId);
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function actualizarTotalPieza(pieceId) {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.actualizarTotalPieza(pieceId);
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        function actualizarTotalIndividual() {
            if (window.app && window.app.managers.calculator) {
                window.app.managers.calculator.actualizarTotalIndividual();
            } else {
                console.error('‚ùå Calculator no disponible');
            }
        }

        // Inicializaci√≥n de la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DOM cargado, inicializando aplicaci√≥n...');
            
            try {
                // Crear instancias globales
                window.authManager = new AuthManager();
                window.authUI = new AuthUI();
                window.storageManager = new UserStorageManager();
                window.app = new App();
                
                // Inicializar la aplicaci√≥n
                await window.app.init();
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico inicializando aplicaci√≥n:', error);
                document.body.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ff4444;">
                        <h2>‚ùå Error de Inicializaci√≥n</h2>
                        <p>Ha ocurrido un error cr√≠tico. Por favor recarga la p√°gina.</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px;">üîÑ Recargar</button>
                    </div>
                `;
            }
        });
    </script>
    
    <!-- Sistema de sincronizaci√≥n r√°pida -->
    <script src="js/quick-sync.js"></script>
    
    <!-- Secci√≥n de configuraci√≥n de usuario en la parte inferior -->
    <footer class="user-settings-footer">
        <div id="userIndicator" class="user-settings-container" style="display: none;">
            <div class="user-info-section">
                <span id="currentUser" class="user-welcome">üë§ Usuario</span>
            </div>
            <div class="user-actions-section">
                <!-- Botones de sincronizaci√≥n compactos -->
                <button id="uploadCloudBtn" class="cloud-action-btn" title="Subir a la nube" onclick="uploadToCloudQuick()">
                    <span class="cloud-icon">‚òÅÔ∏è</span>
                    <span class="arrow-up">‚Üë</span>
                </button>
                <button id="downloadCloudBtn" class="cloud-action-btn" title="Descargar de la nube" onclick="downloadFromCloudQuick()">
                    <span class="cloud-icon">‚òÅÔ∏è</span>
                    <span class="arrow-down">‚Üì</span>
                </button>
                <button id="userMenuBtn" class="user-settings-btn">‚öôÔ∏è Configuraci√≥n</button>
            </div>
        </div>
    </footer>
         
    </body>     
</html>
