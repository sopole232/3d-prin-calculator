// Gestor de interfaz de autenticaci√≥n para Panel de Impresi√≥n 3D
class AuthUI {
    constructor() {
        this.isVisible = false;
    }

    // Mostrar la pantalla de login
    showLoginScreen() {
        if (this.isVisible) return;
        
        this.isVisible = true;
        
        // Crear overlay
        const overlay = document.createElement('div');
        overlay.id = 'authOverlay';
        overlay.className = 'auth-overlay';
        
        overlay.innerHTML = `
            <div class="auth-container">
                <div class="auth-header">
                    <h1>üöÄ Panel de Impresi√≥n 3D</h1>
                    <p>Acceso al sistema</p>
                </div>
                
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="authUI.showTab('login')">Iniciar Sesi√≥n</button>
                    <button class="auth-tab" onclick="authUI.showTab('register')">Registrarse</button>
                </div>

                <!-- Formulario de Login -->
                <div id="loginForm" class="auth-form active">
                    <h3>üîê Iniciar Sesi√≥n</h3>
                    <div class="form-group">
                        <label>Usuario:</label>
                        <input type="text" id="loginUsername" placeholder="Tu nombre de usuario" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a:</label>
                        <input type="password" id="loginPassword" placeholder="Tu contrase√±a" autocomplete="current-password">
                    </div>
                    <button class="btn btn-primary" onclick="authUI.handleLogin()">üöÄ Iniciar Sesi√≥n</button>
                    <div class="auth-demo-info">
                        <small>üí° <strong>Demo:</strong> Si no tienes cuenta, cr√©ate una nueva en "Registrarse"</small>
                    </div>
                </div>

                <!-- Formulario de Registro -->
                <div id="registerForm" class="auth-form">
                    <h3>üìù Crear Cuenta</h3>
                    <div class="form-group">
                        <label>Usuario:</label>
                        <input type="text" id="registerUsername" placeholder="Elige un nombre de usuario (m√≠n. 3 caracteres)" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>Email (opcional):</label>
                        <input type="email" id="registerEmail" placeholder="tu@email.com (opcional)" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a:</label>
                        <input type="password" id="registerPassword" placeholder="M√≠nimo 6 caracteres" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label>Confirmar Contrase√±a:</label>
                        <input type="password" id="registerPasswordConfirm" placeholder="Repite tu contrase√±a" autocomplete="new-password">
                    </div>
                    <button class="btn btn-success" onclick="authUI.handleRegister()">‚ú® Crear Cuenta</button>
                    <div class="auth-demo-info">
                        <small>üîí Tus datos se guardan localmente en tu navegador</small>
                    </div>
                </div>

                <div id="authMessage" class="auth-message"></div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Event listeners para Enter
        this.setupEventListeners();
        
        // Focus en el primer campo
        setTimeout(() => {
            document.getElementById('loginUsername')?.focus();
        }, 100);
    }

    // Ocultar la pantalla de login
    hideLoginScreen() {
        const overlay = document.getElementById('authOverlay');
        if (overlay) {
            overlay.remove();
        }
        this.isVisible = false;
    }

    // Cambiar entre tabs de login y registro
    showTab(tabName) {
        // Actualizar tabs activos
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');

        // Mostrar formulario correspondiente
        document.querySelectorAll('.auth-form').forEach(form => {
            form.classList.remove('active');
        });
        
        if (tabName === 'login') {
            document.getElementById('loginForm').classList.add('active');
            setTimeout(() => document.getElementById('loginUsername')?.focus(), 100);
        } else if (tabName === 'register') {
            document.getElementById('registerForm').classList.add('active');
            setTimeout(() => document.getElementById('registerUsername')?.focus(), 100);
        }

        this.clearMessage();
    }

    // Configurar event listeners
    setupEventListeners() {
        // Enter para enviar formularios
        document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.handleLogin();
        });

        document.getElementById('registerPasswordConfirm')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.handleRegister();
        });

        // Validaci√≥n en tiempo real para registro
        document.getElementById('registerPassword')?.addEventListener('input', (e) => {
            const confirmField = document.getElementById('registerPasswordConfirm');
            if (confirmField.value && confirmField.value !== e.target.value) {
                confirmField.setCustomValidity('Las contrase√±as no coinciden');
            } else {
                confirmField.setCustomValidity('');
            }
        });

        document.getElementById('registerPasswordConfirm')?.addEventListener('input', (e) => {
            const passwordField = document.getElementById('registerPassword');
            if (passwordField.value !== e.target.value) {
                e.target.setCustomValidity('Las contrase√±as no coinciden');
            } else {
                e.target.setCustomValidity('');
            }
        });
    }

    // Manejar login
    async handleLogin() {
        const username = document.getElementById('loginUsername')?.value.trim();
        const password = document.getElementById('loginPassword')?.value;

        if (!username || !password) {
            this.showMessage('Por favor completa todos los campos', 'error');
            return;
        }

        try {
            const user = authManager.login(username, password);
            this.showMessage(`¬°Bienvenido/a ${user.username}! üéâ`, 'success');
            
            setTimeout(() => {
                this.hideLoginScreen();
                // Recargar la aplicaci√≥n con los datos del usuario
                if (window.app) {
                    window.app.onUserLogin();
                }
            }, 1000);

        } catch (error) {
            this.showMessage(`‚ùå Error: ${error.message}`, 'error');
        }
    }

    // Manejar registro
    async handleRegister() {
        const username = document.getElementById('registerUsername')?.value.trim();
        const email = document.getElementById('registerEmail')?.value.trim();
        const password = document.getElementById('registerPassword')?.value;
        const confirmPassword = document.getElementById('registerPasswordConfirm')?.value;

        if (!username || !password || !confirmPassword) {
            this.showMessage('Por favor completa los campos obligatorios', 'error');
            return;
        }

        if (password !== confirmPassword) {
            this.showMessage('Las contrase√±as no coinciden', 'error');
            return;
        }

        try {
            authManager.register(username, password, email);
            
            this.showMessage(`‚úÖ Cuenta creada exitosamente para ${username}!`, 'success');
            
            // Hacer login autom√°tico despu√©s del registro
            setTimeout(() => {
                const user = authManager.login(username, password);
                this.showMessage(`üöÄ Iniciando sesi√≥n...`, 'success');
                
                setTimeout(() => {
                    this.hideLoginScreen();
                    if (window.app) {
                        window.app.onUserLogin();
                    }
                }, 1000);
            }, 1500);

        } catch (error) {
            this.showMessage(`‚ùå Error: ${error.message}`, 'error');
        }
    }

    // Mostrar mensaje
    showMessage(message, type = 'info') {
        const messageDiv = document.getElementById('authMessage');
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.className = `auth-message ${type}`;
        }
    }

    // Limpiar mensaje
    clearMessage() {
        const messageDiv = document.getElementById('authMessage');
        if (messageDiv) {
            messageDiv.textContent = '';
            messageDiv.className = 'auth-message';
        }    }
    
    // Mostrar panel de configuraci√≥n de usuario
    showUserPanel() {
        console.log('üîß Abriendo panel de usuario...');
        
        // Verificar si el usuario est√° logueado
        if (!authManager.isLoggedIn()) {
            console.warn('‚ùå No hay usuario logueado');
            return;
        }

        // Evitar m√∫ltiples aperturas - cerrar si ya existe
        const existingOverlay = document.getElementById('userPanelOverlay');
        if (existingOverlay) {
            console.log('‚ö†Ô∏è Panel de usuario ya est√° abierto, cerrando...');
            this.hideUserPanel();
            return;
        }

        const user = authManager.getCurrentUser();
        const overlay = document.createElement('div');
        overlay.id = 'userPanelOverlay';
        overlay.className = 'auth-overlay';
        
        overlay.innerHTML = `
            <div class="auth-container">
                <div class="auth-header">
                    <h1>üë§ Mi Cuenta</h1>
                    <p>Gesti√≥n de usuario</p>
                </div>

                <div class="user-info">
                    <h3>üìã Informaci√≥n de la Cuenta</h3>
                    <div class="info-grid">
                        <div><strong>Usuario:</strong> ${user.username}</div>
                        <div><strong>Email:</strong> ${user.email || 'No especificado'}</div>
                        <div><strong>Cuenta creada:</strong> ${new Date(user.createdAt).toLocaleDateString('es-ES')}</div>
                        <div><strong>√öltimo acceso:</strong> ${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('es-ES') : 'Primera vez'}</div>
                    </div>
                </div>

                <div class="user-actions">
                    <h3>üîß Acciones</h3>
                    <button class="btn btn-secondary" onclick="authUI.showChangePassword()">üîë Cambiar Contrase√±a</button>
                    <button class="btn btn-warning" onclick="authUI.handleLogout()">üö™ Cerrar Sesi√≥n</button>
                </div>

                <div id="changePasswordSection" class="change-password-section hidden">
                    <h4>üîë Cambiar Contrase√±a</h4>
                    <div class="form-group">
                        <label>Contrase√±a actual:</label>
                        <input type="password" id="currentPassword" placeholder="Tu contrase√±a actual">
                    </div>
                    <div class="form-group">
                        <label>Nueva contrase√±a:</label>
                        <input type="password" id="newPassword" placeholder="Nueva contrase√±a (m√≠n. 6 caracteres)">
                    </div>
                    <div class="form-group">
                        <label>Confirmar nueva contrase√±a:</label>
                        <input type="password" id="confirmNewPassword" placeholder="Repite la nueva contrase√±a">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="authUI.handleChangePassword()">‚úÖ Cambiar</button>
                        <button class="btn btn-secondary" onclick="authUI.hideChangePassword()">‚ùå Cancelar</button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="authUI.hideUserPanel()">‚ùå Cerrar</button>
                </div>

                <div id="userPanelMessage" class="auth-message"></div>
            </div>        `;
        
        // Agregar event listener para cerrar al hacer click fuera del modal
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                this.hideUserPanel();
            }
        });

        // Agregar event listener para cerrar con la tecla Escape
        const escapeHandler = (e) => {
            if (e.key === 'Escape') {
                this.hideUserPanel();
                document.removeEventListener('keydown', escapeHandler);
            }
        };
        document.addEventListener('keydown', escapeHandler);
        
        document.body.appendChild(overlay);
        
        // Aplicar foco al modal para accesibilidad
        setTimeout(() => {
            overlay.focus();
        }, 100);
    }

    // Mostrar secci√≥n de cambiar contrase√±a
    showChangePassword() {
        const section = document.getElementById('changePasswordSection');
        if (section) {
            section.classList.remove('hidden');
            document.getElementById('currentPassword')?.focus();
        }
    }

    // Ocultar secci√≥n de cambiar contrase√±a
    hideChangePassword() {
        const section = document.getElementById('changePasswordSection');
        if (section) {
            section.classList.add('hidden');
            // Limpiar campos
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }
    }

    // Manejar cambio de contrase√±a
    handleChangePassword() {
        const currentPassword = document.getElementById('currentPassword')?.value;
        const newPassword = document.getElementById('newPassword')?.value;
        const confirmPassword = document.getElementById('confirmNewPassword')?.value;

        if (!currentPassword || !newPassword || !confirmPassword) {
            this.showUserPanelMessage('Por favor completa todos los campos', 'error');
            return;
        }

        if (newPassword !== confirmPassword) {
            this.showUserPanelMessage('Las nuevas contrase√±as no coinciden', 'error');
            return;
        }

        try {
            authManager.changePassword(currentPassword, newPassword);
            this.showUserPanelMessage('‚úÖ Contrase√±a cambiada exitosamente', 'success');
            this.hideChangePassword();
        } catch (error) {
            this.showUserPanelMessage(`‚ùå Error: ${error.message}`, 'error');
        }
    }    // Ocultar panel de usuario
    hideUserPanel() {
        const overlay = document.getElementById('userPanelOverlay');
        if (overlay) {
            // Agregar animaci√≥n de salida
            overlay.style.animation = 'fadeOut 0.3s ease-out';
            const container = overlay.querySelector('.auth-container');
            if (container) {
                container.style.animation = 'slideOut 0.3s ease-out';
            }
            
            // Remover despu√©s de la animaci√≥n
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.remove();
                }
            }, 300);
        }
    }

    // Mostrar mensaje en panel de usuario
    showUserPanelMessage(message, type = 'info') {
        const messageDiv = document.getElementById('userPanelMessage');
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.className = `auth-message ${type}`;
        }
    }

    // Manejar logout
    handleLogout() {
        if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
            authManager.logout();
            this.hideUserPanel();
            
            // Mostrar pantalla de login nuevamente
            setTimeout(() => {
                this.showLoginScreen();
            }, 300);
        }
    }    // Mostrar indicador de usuario logueado en la interfaz principal
    updateUserIndicator() {
        const userIndicator = document.getElementById('userIndicator');
        const currentUserSpan = document.getElementById('currentUser');
        const userMenuBtn = document.getElementById('userMenuBtn');
        
        if (!userIndicator || !currentUserSpan || !userMenuBtn) {
            console.warn('‚ùå Elementos del indicador de usuario no encontrados');
            return;
        }

        if (authManager.isLoggedIn()) {
            const user = authManager.getCurrentUser();
            currentUserSpan.textContent = `üë§ ${user.username}`;
            userIndicator.style.display = 'flex';
            
            // Asignar el evento del bot√≥n de men√∫ (siempre para asegurar que funcione)
            userMenuBtn.onclick = () => this.showUserPanel();
            console.log('‚úÖ Indicador de usuario actualizado para:', user.username);
        } else {
            userIndicator.style.display = 'none';
            userMenuBtn.onclick = null;
        }
    }
}

// Funci√≥n global para debugging del bot√≥n de configuraci√≥n
window.debugSettingsButton = function() {
    console.log('üîç Verificando estado del bot√≥n de configuraci√≥n...');
    
    const userIndicator = document.getElementById('userIndicator');
    const currentUserSpan = document.getElementById('currentUser');
    const userMenuBtn = document.getElementById('userMenuBtn');
    
    console.log('üìã Estado de elementos:');
    console.log('  - userIndicator:', userIndicator ? '‚úÖ Encontrado' : '‚ùå No encontrado');
    console.log('  - currentUserSpan:', currentUserSpan ? '‚úÖ Encontrado' : '‚ùå No encontrado');
    console.log('  - userMenuBtn:', userMenuBtn ? '‚úÖ Encontrado' : '‚ùå No encontrado');
    
    if (userMenuBtn) {
        console.log('  - userMenuBtn.onclick:', userMenuBtn.onclick ? '‚úÖ Asignado' : '‚ùå No asignado');
        console.log('  - userMenuBtn.style.display:', userMenuBtn.style.display || 'default');
    }
    
    if (userIndicator) {
        console.log('  - userIndicator.style.display:', userIndicator.style.display || 'default');
    }
    
    console.log('üë§ Estado de autenticaci√≥n:');
    console.log('  - authManager.isLoggedIn():', authManager.isLoggedIn());
    if (authManager.isLoggedIn()) {
        console.log('  - Usuario actual:', authManager.getCurrentUser().username);
    }
    
    // Prueba del bot√≥n
    if (userMenuBtn && userMenuBtn.onclick) {
        console.log('üß™ Puedes probar el bot√≥n ejecutando: document.getElementById("userMenuBtn").click()');
    }
    
    return {
        userIndicator: !!userIndicator,
        userMenuBtn: !!userMenuBtn,
        hasOnClick: !!(userMenuBtn && userMenuBtn.onclick),
        isLoggedIn: authManager.isLoggedIn(),
        isVisible: userIndicator ? userIndicator.style.display !== 'none' : false
    };
};

// Crear instancia global
const authManager = new AuthManager();
const authUI = new AuthUI();
